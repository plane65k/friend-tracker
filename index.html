<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Friend Tracker</title>
<style>
  html, body { height: 100%; margin: 0; }
  #map { height: 100%; width: 100%; display:none; }
  #startButton { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:15px 25px; font-size:18px; }
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
<button id="startButton">Start Tracking Location</button>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- Supabase config ---
const supabaseUrl = 'https://ngyjswujmvkqmqlymrhu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5neWpzd3VqbXZrcW1xbHltcmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzQ1NTEsImV4cCI6MjA3NDY1MDU1MX0.DZ7Nzbms9LLNgIjco9viGPD5rRjlKlbpA75kaN2mp0w';
const supabase = createClient(supabaseUrl, supabaseKey);

// --- Persistent user ID ---
let userId = localStorage.getItem('friendtrack_userId');
if(!userId){
  userId = 'user-' + Math.floor(Math.random()*1000000);
  localStorage.setItem('friendtrack_userId', userId);
}

// --- Variables ---
let map;
let myMarker = null;
let friendMarkers = {};

// --- Update or create marker ---
function updateMyMarker(lat,lng){
  if(!myMarker){
    myMarker = L.circleMarker([lat,lng],{radius:8,color:'#3388ff',fillColor:'#3388ff',fillOpacity:1}).addTo(map);
  } else myMarker.setLatLng([lat,lng]);
  map.setView([lat,lng],16);
}

function updateFriendMarker(data){
  if(data.user_id === userId) return;
  if(!friendMarkers[data.user_id]){
    friendMarkers[data.user_id] = L.marker([data.lat,data.lng],{
      icon:L.icon({iconUrl:'https://upload.wikimedia.org/wikipedia/commons/3/3e/Red_dot.svg',iconSize:[16,16]})
    }).addTo(map);
  } else friendMarkers[data.user_id].setLatLng([data.lat,data.lng]);
}

// --- Write location to Supabase ---
async function writeLocation(lat,lng){
  await supabase.from('locations').upsert({
    user_id: userId,
    lat: lat,
    lng: lng,
    updated_at: new Date()
  });
}

// --- Supabase realtime subscription ---
supabase.from('locations')
  .on('INSERT', payload => updateFriendMarker(payload.new))
  .on('UPDATE', payload => updateFriendMarker(payload.new))
  .subscribe();

// --- Start tracking after user clicks ---
document.getElementById('startButton').addEventListener('click', async ()=>{
  document.getElementById('startButton').style.display='none';
  document.getElementById('map').style.display='block';

  // --- Initialize map ---
  map = L.map('map').setView([0,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  // --- Geolocation ---
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(
      pos=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        updateMyMarker(lat,lng);
        writeLocation(lat,lng);
      },
      err=>console.error('Geo error',err),
      {enableHighAccuracy:true}
    );
  } else alert('Geolocation unsupported');

  // --- Device orientation (heading) ---
  if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation', e=>{
      // Heading logic can be added here later
    }, true);
  }
});
</script>
</body>
</html>
